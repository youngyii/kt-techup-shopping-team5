name: Monolith Deploy

on:
  push:
    branches:
      - deploy/monolith
  pull_request:
    branches:
      - deploy/monolith
  workflow_dispatch:

env:
  JAVA_VERSION: '21'
  JAVA_DISTRIBUTION: 'temurin'

jobs:
  # 테스트 Job
  test:
    name: Run Tests
    runs-on: ubuntu-latest
    permissions:
      contents: read
      checks: write
      pull-requests: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: ${{ env.JAVA_DISTRIBUTION }}
          cache: 'gradle'

      - name: Start MySQL
        run: |
          sudo /etc/init.d/mysql start
          mysql -e 'CREATE DATABASE shopping;' -uroot -proot

      - name: Start Redis
        uses: supercharge/redis-github-action@1.8.0
        with:
          redis-version: 7

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Run tests
        run: ./gradlew test --no-daemon
        env:
          SPRING_PROFILES_ACTIVE: test
          DB_HOST: localhost
          DB_USERNAME: root
          DB_PASSWORD: root
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          AWS_ACCESS_KEY: ${{ secrets.BACK_END_DEPLOYER_ACCESS_KEY }}
          AWS_SECRET_KEY: ${{ secrets.BACK_END_DEPLOYER_SECRET_KEY }}
          SLACK_API_TOKEN: ${{ secrets.SLACK_API_TOKEN }}
          SLACK_LOG_CHANNEL: ${{ secrets.SLACK_LOG_CHANNEL }}

      - name: Publish test results
        uses: EnricoMi/publish-unit-test-result-action@v2
        if: always()
        with:
          files: '**/build/test-results/**/*.xml'

      - name: Send Slack notification (Test Failure)
        uses: 8398a7/action-slack@v3
        with:
          status: custom
          custom_payload: |
            {
              "attachments": [{
                "color": "danger",
                "title": "❌ 모놀리식 테스트 실패",
                "text": "테스트가 실패하여 배포가 중단되었습니다.",
                "fields": [
                  {
                    "title": "Branch",
                    "value": "${{ github.ref_name }}",
                    "short": true
                  },
                  {
                    "title": "Commit",
                    "value": "${{ github.sha }}",
                    "short": true
                  },
                  {
                    "title": "Author",
                    "value": "${{ github.actor }}",
                    "short": true
                  },
                  {
                    "title": "Workflow",
                    "value": "<${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|View Details>",
                    "short": true
                  }
                ]
              }]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        if: failure()

  # 배포 Job (테스트 통과 시에만 실행)
  deploy:
    name: Deploy to AWS
    runs-on: ubuntu-latest
    needs: test
    # push 이벤트이고 deploy/monolith 브랜치일 때만 배포
    if: github.event_name == 'push' && github.ref == 'refs/heads/deploy/monolith'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set environment variables
        run: |
          echo "APP_NAME=javachip-monolith-env" >> $GITHUB_ENV
          echo "ENV_NAME=javachip-monolith-env-env-1" >> $GITHUB_ENV
          echo "TIMESTAMP=$(date +'%Y%m%d-%H%M%S')" >> $GITHUB_ENV

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: ${{ env.JAVA_DISTRIBUTION }}
          cache: 'gradle'

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Build application
        run: ./gradlew bootJar --no-daemon -x test

      - name: Prepare deployment package
        run: |
          mkdir -p deploy
          cp build/libs/*.jar deploy/application.jar
          echo "web: java -Dserver.port=5000 -jar application.jar" > deploy/Procfile
          cd deploy
          zip -r ${{ env.APP_NAME }}-${{ env.TIMESTAMP }}.zip .
          mv ${{ env.APP_NAME }}-${{ env.TIMESTAMP }}.zip ../

      - name: Deploy to AWS Elastic Beanstalk
        uses: einaregilsson/beanstalk-deploy@v22
        with:
          aws_access_key: ${{ secrets.BACK_END_DEPLOYER_ACCESS_KEY }}
          aws_secret_key: ${{ secrets.BACK_END_DEPLOYER_SECRET_KEY }}
          application_name: ${{ env.APP_NAME }}
          environment_name: ${{ env.ENV_NAME }}
          version_label: ${{ env.APP_NAME }}-monolith-${{ env.TIMESTAMP }}
          region: ap-northeast-2
          deployment_package: ${{ env.APP_NAME }}-${{ env.TIMESTAMP }}.zip

      - name: Send Slack notification (Success)
        uses: 8398a7/action-slack@v3
        with:
          status: custom
          custom_payload: |
            {
              "attachments": [{
                "color": "good",
                "title": "✅ 모놀리식 배포 성공",
                "text": "배포가 성공적으로 완료되었습니다!",
                "fields": [
                  {
                    "title": "Environment",
                    "value": "${{ env.ENV_NAME }}",
                    "short": true
                  },
                  {
                    "title": "Version",
                    "value": "${{ env.APP_NAME }}-monolith-${{ env.TIMESTAMP }}",
                    "short": true
                  },
                  {
                    "title": "Commit",
                    "value": "${{ github.sha }}",
                    "short": true
                  },
                  {
                    "title": "Author",
                    "value": "${{ github.actor }}",
                    "short": true
                  },
                  {
                    "title": "Region",
                    "value": "ap-northeast-2",
                    "short": true
                  },
                  {
                    "title": "Workflow",
                    "value": "<${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|View Details>",
                    "short": true
                  }
                ]
              }]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        if: success()

      - name: Send Slack notification (Failure)
        uses: 8398a7/action-slack@v3
        with:
          status: custom
          custom_payload: |
            {
              "attachments": [{
                "color": "danger",
                "title": "❌ 모놀리식 배포 실패",
                "text": "배포 중 오류가 발생했습니다. 확인이 필요합니다.",
                "fields": [
                  {
                    "title": "Environment",
                    "value": "${{ env.ENV_NAME }}",
                    "short": true
                  },
                  {
                    "title": "Commit",
                    "value": "${{ github.sha }}",
                    "short": true
                  },
                  {
                    "title": "Author",
                    "value": "${{ github.actor }}",
                    "short": true
                  },
                  {
                    "title": "Workflow",
                    "value": "<${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|View Details>",
                    "short": true
                  }
                ]
              }]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        if: failure()
